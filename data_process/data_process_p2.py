# -*- coding: utf-8 -*-
"""
ç¬¬äºŒæ­¥å¤„ç†è„šæœ¬ï¼šè¯»å– result.txtï¼Œé€æ®µè°ƒç”¨ LLM æ¸…æ´—é“¾æ¡ -> result_refined.txt
"""

import os
import sys
from dotenv import load_dotenv
import requests

load_dotenv()

# ====== é…ç½®åŒº ======
API_KEY = os.getenv("OPENAI_API_KEY", "")
BASE_URL = os.getenv("OPENAI_API_BASE_URL", "https://api.openai.com/v1").rstrip("/")
MODEL = os.getenv("LLM_MODEL", "gemini-2.5-flash-preview-05-20")   # ä½ å¯ä»¥æ¢æˆ gpt-4o, gpt-4.1, deepseek ç­‰

if not API_KEY:
    raise RuntimeError("âŒ OPENAI_API_KEY æœªè®¾ç½®")

# ====== å·¥å…·å‡½æ•° ======
def call_llm(prompt: str) -> str:
    """
    è°ƒç”¨ LLM APIï¼Œè¿”å›žæ¨¡åž‹è¾“å‡ºæ–‡æœ¬
    """
    url = f"{BASE_URL}/chat/completions"
    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }
    data = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼éµå®ˆè§„åˆ™çš„æ•…éšœè¯Šæ–­é“¾æ¸…æ´—å™¨ã€‚"},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.0
    }

    resp = requests.post(url, headers=headers, json=data, timeout=180)
    resp.raise_for_status()
    result = resp.json()
    if result["choices"][0]["message"]["content"].strip() == "null":
        return ""
    return result["choices"][0]["message"]["content"].strip()


def read_chains(file_path: str):
    """
    æŒ‰ç©ºè¡Œåˆ†éš”è¯»å–æ–‡ä»¶ï¼Œè¿”å›žé“¾æ¡åˆ—è¡¨
    """
    chains = []
    current = []

    with open(file_path, "r", encoding="utf-8") as f:
        for line in f:
            line = line.strip()
            if line == "":
                if current:
                    chains.append("\n".join(current))
                    current = []
            else:
                current.append(line)

        if current:
            chains.append("\n".join(current))

    return chains


def refine_chain_with_llm(chain: str) -> str:
    """
    ç”¨å¤§è¯­è¨€æ¨¡åž‹æ¸…æ´—é“¾æ¡
    """
    prompt = f"""
ä½ æ˜¯ä¸€ä¸ªâ€œæœ€å°å¯ç”¨é“¾æ¡æç‚¼å™¨â€ã€‚è¾“å…¥æ˜¯ä¸€æ®µã€å®Œæ•´é“¾æ¡ã€‘ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼Œæ¯è¡Œä¸€ä¸ªèŠ‚ç‚¹ï¼›ç¬¬ 1 è¡Œæ˜¯ã€çŽ°è±¡ã€‘ï¼‰ã€‚
è¯·å°†å…¶åŽ‹ç¼©ä¸ºâ€œæœ€å°å¯ç”¨é“¾æ¡â€ï¼Œéµå®ˆä»¥ä¸‹è§„åˆ™ï¼š

ã€ç›®æ ‡ã€‘
- ä¿ç•™èƒ½æ”¯æ’‘æœ€ç»ˆåŠ¨ä½œçš„**å…³é”®å¼‚å¸¸ç‰¹å¾**ï¼ˆè‹¥åŽŸæ–‡ä¸­æ˜Žç¡®å‡ºçŽ°ï¼‰ã€‚
- åˆ é™¤è¢«äº‹å®žå¦å®šæˆ–ä¸ŽæˆåŠŸæ— å…³çš„æ­¥éª¤ã€‚
- ç»“å°¾å¿…é¡»æ˜¯ä¸€ä¸ª**å…·ä½“å¯æ‰§è¡ŒåŠ¨ä½œ**ã€‚

ã€ç¡¬æ€§è§„åˆ™ã€‘
1) **ä¿ç•™ç¬¬ 1 è¡ŒçŽ°è±¡**ï¼ˆåŽŸæ ·ä¿ç•™ï¼‰ã€‚
2) å¦‚æžœé“¾æ¡æœ€åŽä¸€å¥æ˜¯â€œè”ç³»å”®åŽ/è½¬äººå·¥/è”ç³»å®¢æœ/å»ºè®®è”ç³»ä¸“ä¸šçš„å”®åŽæŠ€æœ¯æ”¯æŒäººå‘˜èŽ·å¾—å¸®åŠ©â€ç­‰è¯æœ¯ï¼Œåˆ™**ä»…è¾“å‡º null è¿™ä¸ªå•è¯*ã€‚
3) åˆ é™¤è¡¨ç¤ºæ­£å¸¸/å¦å®š/æˆåŠŸ/æ¢å¤çš„è¡Œï¼ˆå¦‚ï¼šæ­£å¸¸ã€å¦ã€åœ¨çº¿ã€æˆåŠŸã€æ¢å¤æ­£å¸¸ã€èƒ½å¼€æœº/èƒ½å‘è½¦ ç­‰ï¼‰ã€‚
4) è‹¥æŸæ­¥éª¤åŽç´§è·Ÿâ€œä»ä¸èƒ½å¼€æœº/æœªè§£å†³â€ç­‰å¦å®šï¼Œå†ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œè¯´æ˜Žè¯¥æ­¥éª¤æ— æ•ˆï¼š**åˆ é™¤è¯¥æ­¥éª¤åŠå…¶å¦å®šç»“æžœ**ã€‚
5) **åªä¿ç•™æœ€åŽä¸€ä¸ªæœ‰æ•ˆåŠ¨ä½œ**ä½œä¸ºé“¾æ¡æ”¶å°¾ï¼ˆå¦‚ï¼šå……ç”µã€é‡å¯ã€è°ƒæ•´ã€æ›¿æ¢ã€ä¿®å¤ã€å‡çº§ã€åŠ å›ºã€ç»Ÿä¸€é…ç½® ç­‰ï¼‰ã€‚ç»“å°¾ç¦æ­¢â€œæ£€æŸ¥/ç¡®è®¤/è§‚å¯Ÿâ€ã€‚
6) **å¼‚å¸¸ç‰¹å¾çš„ä¿ç•™ç­–ç•¥**ï¼š
   - ä»…å½“åŽŸæ–‡æœ¬ä¸­å­˜åœ¨**æ˜Žç¡®çš„å¼‚å¸¸ç»“æžœ**ï¼ˆå¦‚â€œRCS æ—¥å¿—æ˜¾ç¤ºç”µé‡ä½Ž/â€¦ä¸è¶³/â€¦å¼‚å¸¸/â€¦æŸå/â€¦ç¦»çº¿/æ— æ³•â€¦/ä¸å·¥ä½œ/è¿‡é«˜/è¿‡ä½Žâ€ç­‰ï¼‰æ—¶ï¼Œ**ä¿ç•™å…¶ä¸­æœ€èƒ½ç›´æŽ¥æ”¯æ’‘æœ€ç»ˆåŠ¨ä½œçš„ä¸€æ¡**ï¼Œæ”¾åœ¨åŠ¨ä½œä¹‹å‰ã€‚
   - **ç¦æ­¢è‡†é€ **å¼‚å¸¸ç‰¹å¾ï¼ˆä¾‹å¦‚â€œç”µæ± è¿žæŽ¥çº¿å¼‚å¸¸â€ä¸èƒ½å‡­ç©ºæ·»åŠ ï¼Œé™¤éžåŽŸæ–‡æ˜Žç¡®ç»™å‡ºç±»ä¼¼è¡¨è¿°ï¼‰ã€‚
   - è‹¥åŽŸæ–‡æ²¡æœ‰æ˜Žç¡®å¼‚å¸¸ç»“æžœï¼Œåˆ™ä¸å†™ç‰¹å¾ï¼Œç›´æŽ¥è¾“å‡ºä¸¤è¡Œï¼ˆçŽ°è±¡ + åŠ¨ä½œï¼‰ã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘
- çº¯æ–‡æœ¬ï¼Œå¤šè¡Œï¼›ä¸ä½¿ç”¨ç¼–å·/åˆ—è¡¨/JSONã€‚
- ä¸€æ¡é“¾å³å¯ï¼›å¤šæ¡é“¾ä¹‹é—´ä»¥ç©ºè¡Œåˆ†éš”ï¼ˆæœ¬æ¬¡ä»…å¤„ç†ä¸€æ®µè¾“å…¥ï¼‰ã€‚

ã€ç¤ºä¾‹ã€‘
ç¤ºä¾‹Aï¼ˆå¿…é¡»ä¿ç•™å¼‚å¸¸ç‰¹å¾ï¼‰ï¼š
åŽŸå§‹ï¼š
æœºå™¨äººå¼€ä¸äº†æœº
æŸ¥çœ‹RCSæ—¥å¿—æ˜¾ç¤ºç”µé‡ä½Ž
è¿›è¡Œæ‰‹åŠ¨å……ç”µ
æœºå™¨äººèƒ½å¼€æœº

è¾“å‡ºï¼š
æœºå™¨äººå¼€ä¸äº†æœº
æŸ¥çœ‹RCSæ—¥å¿—æ˜¾ç¤ºç”µé‡ä½Ž
è¿›è¡Œæ‰‹åŠ¨å……ç”µ

ç¤ºä¾‹Bï¼ˆæ— æ˜Žç¡®ç‰¹å¾ â†’ ä¸¤è¡Œè¾“å‡ºï¼‰ï¼š
åŽŸå§‹ï¼š
æœºå™¨äººå¼€ä¸äº†æœº
æŸ¥çœ‹RCSæ—¥å¿—æ˜¾ç¤ºä¸æ˜¯ç”µé‡ä½Ž
æ£€æŸ¥ç”µæ± è¿žæŽ¥çº¿
æœºå™¨äººèƒ½å¼€æœº

è¾“å‡ºï¼š
æœºå™¨äººå¼€ä¸äº†æœº
é‡æ–°æ’ç´§æˆ–æ›´æ¢ç”µæ± è¿žæŽ¥çº¿

ç¤ºä¾‹Cï¼ˆå‰ä¸€æ­¥æ— æ•ˆï¼ŒåŽä¸€æ­¥ç”Ÿæ•ˆï¼›æ— æ˜Žç¡®ç‰¹å¾ â†’ ä¸¤è¡Œè¾“å‡ºï¼‰ï¼š
åŽŸå§‹ï¼š
æœºå™¨äººå¼€ä¸äº†æœº
æ£€æŸ¥ç”µæ± è¿žæŽ¥çº¿
æœºå™¨äººä¸èƒ½å¼€æœº
æ£€æŸ¥ç”µæ± æ¨¡å—
æœºå™¨äººèƒ½å¼€æœº

è¾“å‡ºï¼š
æœºå™¨äººå¼€ä¸äº†æœº
æ›´æ¢ç”µæ± æ¨¡å—

ã€å¾…æ¸…æ´—é“¾æ¡ã€‘ï¼š
{chain}

ã€è¯·è¾“å‡ºç¬¦åˆè§„åˆ™çš„æœ€å°å¯ç”¨é“¾æ¡ã€‘ï¼š

    """
    return call_llm(prompt)


def process_result_file(input_path: str, output_path: str):
    """
    è¯»å–æ–‡ä»¶ -> è°ƒç”¨ LLM é€é“¾æ¸…æ´— -> è¾“å‡ºæ–°æ–‡ä»¶
    """
    chains = read_chains(input_path)

    with open(output_path, "w", encoding="utf-8") as out:
        for i, chain in enumerate(chains, 1):
            print(f"ðŸš€ æ­£åœ¨å¤„ç†ç¬¬ {i}/{len(chains)} æ®µ...")
            print(f"åŽŸå§‹é“¾æ¡ï¼š\n{chain}\n")
            refined = refine_chain_with_llm(chain)
            print(f"æ¸…æ´—åŽé“¾æ¡ï¼š\n{refined}\n")
            if refined.strip():
                out.write(refined + "\n\n")

    print(f"âœ… å·²å¤„ç†å®Œæˆï¼Œç»“æžœå†™å…¥ {output_path}")


if __name__ == "__main__":
    input_file = "result.txt"
    output_file = "result_refined.txt"

    if len(sys.argv) >= 2:
        input_file = sys.argv[1]
    if len(sys.argv) >= 3:
        output_file = sys.argv[2]

    process_result_file(input_file, output_file)
